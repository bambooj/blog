---
title: 使用Elasticsearch对文章进行分词统计
date: 2018-08-21 18:22:40
tags:
---

需求：通过公司名称，查询公司的统一社会信用代码(企查查)；使用统一社会信用代码，调用风报(收费)接口，找到公司的裁判文书信息；返回信息格式如下：
```
{
    "_id" : "0533f2d0-6fc4-4f79-a5b6-bc6d33a2c3f0",
    "法院" : "旌德县人民法院",
    "案号" : "（2015）旌民二初字第00098号",
    "案由" : "承揽合同纠纷",
    "段落" : [ 
        {
            "标签" : "头部",
            "内容" : "安徽省旌德县人民法院"
        }, 
        {
            "标签" : "庭审程序说明",
            "内容" : "被告贝利公司经本院传票传唤无正当理由未到庭参加诉讼。"
        }, 
        {
            "标签" : "庭审程序说明",
            "内容" : "本案现已审理终结。"
        }, 
        {
            "标签" : "庭审过程其他",
            "内容" : "原告为证明其诉讼主张，向本院递交的证据，被告樊建儿的质证意见及本院的认证意见如下："
        }, 
        {
            "标签" : "庭审过程其他",
            "内容" : "2、《粉刷分项工程承包协议书》1份，证明两原告与被告贝利公司项目部签订协议，由原告分包粉刷工程，并对工程概况、范围、质量及保修、承包方式造价及付款进行了约定，明确了双方的权利义务。"
        }, 
        {
            "标签" : "附件",
            "内容" : "第一百四十四条被告经传票传唤，无正当理由拒不到庭的，或者未法庭许可中途退庭的，可以缺席判决。"
        }
    ],
    "当事人" : [ 
        {
            "其他角色" : [],
            "名字" : "建儿",
            "判决结果" : "败诉",
            "角色" : [ 
                "被告"
            ],
            "类型" : "人名"
        }
    ],
    "文书类型" : "判决书",
    "versions" : 1,
    "发布时间" : "2016-03-24",
    "判决时间" : "2016-01-04",
    "统一社会信用代码" : "91330110143843494L",
    "标题" : "AAA与贝利建设集团有限公司合同纠纷一审民事判决书"
}
```
需要对“段落.内容”进行分析。

### 一、 公司对于的社会统一信用代码
公司名称                    统一社会信用代码
中建二局第一建筑工程有限公司：91110000104341301L
浙江贝利                   ：91330110143843494L
河北太行建筑安装工程有限公司：91130606700751737C

### 二、 给“段落.标签”字段建立映射，使用中文ik_analyzer分词
```
curl -X PUT "localhost:9200/abs_enterprise_info" -d'
{
   "mappings": {
    "cpws":{
       "properties":{
            "段落": {
                "type": "object",
                "properties":{
                    "内容": {
                       "analyzer": "ik_smart",
                        "type": "text",
                        "fielddata":"true"
                    }
                }
            }
        }
    }
  }
}'
```

建立完映射，可以对其进行分析，测试如下：
```
curl -X POST "localhost:9200/abs_enterprise_info/_analysis?pretty" -d'
{
    "field": "段落.内容",
    "tags": "上诉人深圳市明之辉建设工程有限公司（以下简称“明之辉公司”）因与被上诉人杨光权承揽合同纠纷一案，明之辉公司不服贵州省余庆县人民法院（2017）黔0329民初1802号民事判决，向本院提起上诉，本院于2018年1月5日立案受理后，依法组成合议庭审理了本案，本案现已审理终结。"
}'
```

### 三、 通过“统一社会信用代码”，查询符合的记录数（如有100条数据），再对其进行词频统计
```
curl -X POST "localhost:9200/abs_enterprise_info/_search?pretty" -o 91130606700751737C.txt -d'
{
    "query": {
        "match": {
            "统一社会信用代码": "91130606700751737C"
        }
    },
    "size": 0,
    "aggs": {
        "messages": {
            "terms": {
                "size": 10,
                "field": "段落.内容",
                "include":"[\u4E00-\u9FA5]{2,6}",
                "exclude" : ".*百.*|.*人.*|.*市.*|.*一.*|.*二.*|.*三.*|.*四.*|.*五.*|.*六.*|.*七.*|.*八.*|.*九.*|.*十.*"
            }
        }
    }
}'
```

* include：包含2-6个中文单词的bucket key；过滤key少于两个汉子的数据的方法，参考：http://www.mamicode.com/info-detail-1669192.html；
* excude: 通过正则表达式过滤掉一部分数据，注：过滤太多程序无法解析，会出现错误；
* -o:将结果输入到文件91130606700751737C.txt中；
输出结果的格式：
```
{
  "took" : 174,
  "timed_out" : false,
  "_shards" : {
    "total" : 5,
    "successful" : 5,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : 31,
    "max_score" : 0.0,
    "hits" : [ ]
  },
  "aggregations" : {
    "messages" : {
      "doc_count_error_upper_bound" : 21,
      "sum_other_doc_count" : 4102,
      "buckets" : [
        {
          "key" : "依照",
          "doc_count" : 28
        },
        {
          "key" : "太行",
          "doc_count" : 27
        },
        {
          "key" : "如下",
          "doc_count" : 27
        },
        {
          "key" : "工程",
          "doc_count" : 27
        },
        {
          "key" : "建筑安装",
          "doc_count" : 27
        },
        {
          "key" : "有限公司",
          "doc_count" : 27
        },
        {
          "key" : "本院",
          "doc_count" : 27
        },
        {
          "key" : "民事诉讼法",
          "doc_count" : 27
        },
        {
          "key" : "河北",
          "doc_count" : 27
        },
        {
          "key" : "原告",
          "doc_count" : 25
        }
      ]
    }
  }
}
```

如果想对某一类数据进行分析，可以使用query.bool：
```
curl -X POST "localhost:9200/abs_enterprise_info/_search?pretty" -d'
{
    "query": {
        "bool":{
            "must":{"match":{"统一社会信用代码": "91330110143843494L"}},
            "must":{"match":{"案由": "建设工程施工合同纠纷"}}
        }
    }
}'
```

### 四、 使用awk对输出到文件的内容进一步处理，执行:
awk -F":" '{if($1~/key/) print $2}' 91130606700751737C.txt > 91130606700751737C_tag.txt
只保留中文关键字,并将结果放到新的文件中(如：91130606700751737C_tag.txt)
### 五、 去掉双引号-F"\""，并去掉换行符printf
> awk -F"\"" '{printf $2 $3}' 91130606700751737C_tag.txt

### 六、 过滤掉一部分数据，如过滤包含"高"，"区"，"都"，"这"的词条，这个是在未取消换行的时候执行的
> awk '{if(!($0~/高|区|都|这/)) print $0}' 91130606700751737C_tag.txt

或

> awk '{if($0!~/高|区|都|这/) print $0}' awkt2.txt